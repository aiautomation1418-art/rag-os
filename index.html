<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Professional Chat UI</title>
  <!-- Load Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Load Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* Use Inter font */
    body {
      font-family: 'Inter', sans-serif;
    }

    /* Custom scrollbar for message list */
    #messages {
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 #f1f5f9;
    }

    #messages::-webkit-scrollbar {
      width: 6px;
    }

    #messages::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 10px;
    }

    #messages::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 10px;
      border: 3px solid #f1f5f9;
    }
    
    /* Custom scrollbar for history list */
    #historyList {
      scrollbar-width: thin;
      scrollbar-color: #e2e8f0 #f8fafc;
    }
    
    #historyList::-webkit-scrollbar {
      width: 6px;
    }
    
    #historyList::-webkit-scrollbar-track {
      background: #f8fafc;
      border-radius: 10px;
    }
    
    #historyList::-webkit-scrollbar-thumb {
      background-color: #e2e8f0;
      border-radius: 10px;
      border: 3px solid #f8fafc;
    }

    /* Spinner animation */
    .spinner {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid rgba(0, 0, 0, 0.08);
      border-top-color: #0b74de; /* Blue accent color */
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-left: 4px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    
    /* Styles for rendered H1, H2, etc. inside the chat bubble */
    .prose {
        color: inherit; /* Inherit text color from parent bubble */
    }
    .prose h1, .prose h2, .prose h3, .prose p {
        margin-top: 0.75em;
        margin-bottom: 0.75em;
    }
    .prose h1 {
        font-size: 1.25rem; /* 20px */
        font-weight: 600;
    }
    .prose h2 {
        font-size: 1.125rem; /* 18px */
        font-weight: 600;
    }
    .prose h3 {
        font-size: 1rem; /* 16px */
        font-weight: 600;
    }
    .prose p {
        font-size: 0.875rem; /* 14px */
    }
    /* Remove top margin for the first element in the prose */
    .prose > :first-child {
        margin-top: 0;
    }
    /* Remove bottom margin for the last element in the prose */
    .prose > :last-child {
        margin-bottom: 0;
    }
    
  </style>
</head>
<body class="bg-slate-100">

  <div class="flex h-screen w-full p-2 md:p-4">
    
    <!-- Left Sidebar Navigation -->
    <nav class="hidden md:flex flex-col w-16 p-2 bg-white rounded-xl shadow-sm border border-slate-200 items-center gap-y-4">
      <!-- Logo -->
      <a href="#" class="p-2 bg-green-100 text-green-600 rounded-lg">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
      </a>

      <!-- New Conversation Button (using the existing ID for JS) -->
      <button id="newConv" title="New Conversation" class="p-3 bg-slate-100 text-slate-700 hover:bg-blue-100 hover:text-blue-600 rounded-lg transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
      </button>
      
      <!-- Other icons (example) -->
      <div class="flex flex-col gap-y-2 mt-auto">
         <button title="Settings" class="p-3 text-slate-500 hover:bg-slate-100 hover:text-slate-800 rounded-lg transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings-2"><path d="M20 7h-9a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h9a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2Z"/><path d="M14 21v-2a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v2"/><path d="M12 17V5"/></svg>
         </button>
         <button title="Profile" class="p-2 text-slate-500 rounded-lg">
            <img src="https://placehold.co/32x32/e0e7ff/6366f1?text=A&font=sans" alt="User" class="w-8 h-8 rounded-full">
         </button>
      </div>
    </nav>

    <!-- Main Chat Area -->
    <div class="flex flex-col flex-1 mx-0 md:mx-4 bg-white rounded-xl shadow-sm border border-slate-200">
      
      <!-- Chat Header -->
      <header class="flex items-center justify-between p-4 border-b border-slate-200">
        <!-- === CHANGED TEXT HERE === -->
        <h1 class="text-lg font-semibold text-slate-800">OS Chat Bot</h1>
        <!-- Mobile Nav Toggle (for future use) -->
        <div class="flex items-center gap-2">
            <button id="newConvMobile" class="md:hidden p-2 bg-slate-100 text-slate-700 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
            </button>
            <button id="historyToggle" class="md:hidden p-2 bg-slate-100 text-slate-700 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-history"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>
            </button>
        </div>
      </header>

      <!-- Messages Area -->
      <div id="messages" class="flex-1 p-4 md:p-6 overflow-y-auto space-y-5">
        <!-- Messages will be rendered here by JS -->
      </div>

      <!-- Composer / Text Input -->
      <div class="p-4 md:p-6 border-t border-slate-200 bg-white rounded-b-xl">
        <div class="flex items-end p-2 bg-slate-100 rounded-lg border border-slate-200 focus-within:ring-2 focus-within:ring-blue-500">
          <textarea id="input" placeholder="Ask or search anything..." class="flex-1 p-2 bg-transparent border-none resize-none focus:ring-0 text-sm text-slate-700 placeholder:text-slate-500" rows="1" style="min-height: 2.5rem; max-height: 10rem;"></textarea>
          <button id="send" title="Send Message" class="w-9 h-9 flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors ml-2 flex-shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send-horizontal"><path d="m3 3 3 9-3 9 19-9Z"/><path d="M6 12h16"/></svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Right History Panel -->
    <aside id="historyPanel" class="hidden lg:flex flex-col w-full max-w-sm p-4 bg-white rounded-xl shadow-sm border border-slate-200">
      <div class="flex items-center justify-between pb-3 border-b border-slate-200">
        <h2 class="font-semibold text-slate-800">History Chat</h2>
        <span id="convCount" class="text-sm font-medium text-slate-500 bg-slate-100 px-2 py-0.5 rounded-full">0</span>
      </div>
      
      <!-- History List -->
      <div id="historyList" class="flex-1 mt-4 space-y-2 overflow-y-auto -mr-2 pr-2">
        <!-- History items will be rendered here by JS -->
      </div>
      
      <!-- Pro Plan Card (from image) -->
      <div class="mt-4 p-5 rounded-xl bg-gradient-to-br from-green-400 to-cyan-500 text-white relative overflow-hidden">
        <div class="relative z-10">
          <h3 class="text-lg font-semibold">Pro Plan</h3>
          <p class="text-sm opacity-90 mt-1 mb-4">Get various other interesting features</p>
          <button class="w-full bg-slate-900/80 hover:bg-slate-900 text-white text-sm font-medium py-2.5 px-4 rounded-lg transition-colors">
            Get Pro Plan Now
          </button>
        </div>
      </div>
    </aside>
  </div>

  <script>
    // âœ… Updated Webhook URL (new ngrok endpoint)
    // const WEBHOOK_URL = 'https://delilah-unclever-malcolm.ngrok-free.dev/webhook-test/rag/os';
    // Using a placeholder for demonstration
    const WEBHOOK_URL = 'https://delilah-unclever-malcolm.ngrok-free.dev/webhook/rag/os'; // Placeholder API for testing

    const STORAGE_KEY = 'chat_conversations_v2'; // Updated key
    const SESSION_KEY = 'chat_session_id_v2'; // Updated key
    
    function getSessionId() {
      try {
        let s = sessionStorage.getItem(SESSION_KEY);
        if (!s) {
          s = 's_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 10);
          sessionStorage.setItem(SESSION_KEY, s);
        }
        return s;
      } catch (e) {
        if (!window.__CHAT_FALLBACK_SESSION) window.__CHAT_FALLBACK_SESSION = 's_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 10);
        return window.__CHAT_FALLBACK_SESSION;
      }
    }

    const $ = (sel, ctx = document) => ctx.querySelector(sel);
    const timeNow = () => new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    
    let conversations = [];
    let activeId = null;

    const messagesEl = $('#messages');
    const historyListEl = $('#historyList');
    const inputEl = $('#input');
    const sendBtn = $('#send');
    const newConvBtn = $('#newConv');
    const newConvMobileBtn = $('#newConvMobile'); // Mobile button
    const convCountEl = $('#convCount');

    // --- Auto-resize textarea ---
    function autoResizeTextarea() {
      inputEl.style.height = 'auto';
      inputEl.style.height = (inputEl.scrollHeight) + 'px';
    }
    inputEl.addEventListener('input', autoResizeTextarea);

    function load() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        conversations = raw ? JSON.parse(raw) : [];
      } catch (e) {
        conversations = [];
      }
      
      // Sort conversations by most recent
      conversations.sort((a, b) => b.updatedAt - a.updatedAt);

      if (!conversations || conversations.length === 0) {
        startNewConversation();
      } else {
        activeId = conversations[0].id;
      }
      
      renderAll();
    }
    
    function persist() {
      if (!conversations || conversations.length === 0) return;
      // Find active conversation and update its timestamp
      const activeConv = getActiveConv();
      if(activeConv) activeConv.updatedAt = Date.now();
      
      // Re-sort before saving
      conversations.sort((a, b) => b.updatedAt - a.updatedAt);
      
      localStorage.setItem(STORAGE_KEY, JSON.stringify(conversations));
    }
    
    function makeId() {
      return 'c_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 8);
    }
    
    function getActiveConv() {
      return conversations.find(c => c.id === activeId);
    }

    function renderAll() {
      renderMessages();
      renderHistory();
      autoResizeTextarea(); // Ensure textarea is correct size on load
    }

    function renderMessages() {
      const conv = getActiveConv();
      messagesEl.innerHTML = '';
      if (!conv || !conv.messages) return;
      
      conv.messages.forEach(m => messagesEl.appendChild(renderMessageEl(m)));
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    
    function renderMessageEl(m) {
      const msgWrapper = document.createElement('div');
      const isUser = m.role === 'user';
      
      // Avatar
      const avatar = document.createElement('img');
      avatar.className = 'w-8 h-8 rounded-full flex-shrink-0';
      avatar.src = isUser 
        ? 'https://placehold.co/40x40/e0e7ff/6366f1?text=U&font=sans' 
        : 'https://placehold.co/40x40/d1fae5/10b981?text=AI&font=sans';
      avatar.alt = isUser ? 'User' : 'Bot';

      // Message Bubble
      const msgBubble = document.createElement('div');
      msgBubble.className = `msg-bubble relative max-w-xl px-4 py-3 rounded-lg shadow-sm`;
      
      if (isUser) {
        msgWrapper.className = 'flex items-start gap-3 justify-end';
        msgBubble.className += ' bg-blue-600 text-white rounded-br-none';
      } else {
        msgWrapper.className = 'flex items-start gap-3';
        msgBubble.className += ' bg-slate-50 border border-slate-200 text-slate-800 rounded-bl-none';
      }

      // Message Content
      const textDiv = document.createElement('div');
      // Added 'prose' class to style H1, P, etc.
      textDiv.className = 'text-sm prose prose-sm max-w-none'; 
      textDiv.innerHTML = escapeAndFormat(m.text); // Use formatting
      
      // Meta (Timestamp or Loading)
      const metaDiv = document.createElement('div');
      metaDiv.className = 'meta text-xs mt-2';

      if (m.loading) {
        metaDiv.className += ' text-slate-500';
        metaDiv.textContent = 'Typingâ€¦ ';
        const spinner = document.createElement('span');
        spinner.className = 'spinner';
        metaDiv.appendChild(spinner);
      } else {
        metaDiv.className += isUser ? 'text-blue-200' : 'text-slate-500';
        metaDiv.textContent = m.time;
      }

      msgBubble.appendChild(textDiv);
      msgBubble.appendChild(metaDiv);
      
      if (isUser) {
        msgWrapper.appendChild(msgBubble);
        msgWrapper.appendChild(avatar);
      } else {
        msgWrapper.appendChild(avatar);
        msgWrapper.appendChild(msgBubble);
      }
      
      return msgWrapper;
    }

    // === FUNCTION CHANGED ===
    function escapeAndFormat(str) {
      // --- USER REQUESTED CHANGE ---
      // This function NO LONGER escapes HTML tags, to allow <h1>, <h2>, etc.
      // WARNING: This is a potential security risk if you do not TRUST
      // your chatbot's output. A malicious response could run scripts.
      // Only use this if you control the bot's output completely.
      
      // 1. Escape HTML (REMOVED)
      /*
      let escaped = String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
      */
      
      // 2. Format newlines to <br>
      // We still format newlines, but on the raw string
      let formatted = String(str).replace(/\n/g, '<br>');
      
      // Return the raw string (with newlines converted)
      return formatted;
    }

    function renderHistory() {
      historyListEl.innerHTML = '';
      convCountEl.textContent = conversations.length;
      
      if (!conversations || conversations.length === 0) {
          historyListEl.innerHTML = `<p class="text-sm text-slate-500 p-3">No conversations yet.</p>`;
          return;
      }
      
      conversations.forEach(conv => {
        const item = document.createElement('div');
        item.className = `p-3 rounded-lg cursor-pointer group transition-colors ${conv.id === activeId ? 'bg-blue-50' : 'hover:bg-slate-50'}`;
        item.setAttribute('data-id', conv.id);
        
        const title = document.createElement('div');
        title.className = `text-sm font-medium truncate ${conv.id === activeId ? 'text-blue-700' : 'text-slate-700 group-hover:text-slate-900'}`;
        title.textContent = conv.title;
        
        const sub = document.createElement('div');
        sub.className = 'text-xs text-slate-500 mt-1';
        // Show last message preview
        const lastMsg = conv.messages.length > 0 ? conv.messages[conv.messages.length - 1].text : 'No messages...';
        // Strip HTML tags from preview
        const previewText = lastMsg.replace(/<[^>]*>?/gm, ' ');
        sub.textContent = previewText.substring(0, 40) + (previewText.length > 40 ? '...' : '');

        item.appendChild(title);
        item.appendChild(sub);
        
        item.addEventListener('click', () => {
          activeId = conv.id;
          renderAll();
        });
        
        historyListEl.appendChild(item);
      });
    }

    async function sendMessage(text) {
      if (!text || !text.trim()) return;
      
      const conv = getActiveConv();
      const userMsg = { role: 'user', text: text.trim(), time: timeNow() };
      conv.messages.push(userMsg);
      
      // Update title if it's a new conversation
      if (conv.messages.length === 1 && conv.title === 'New conversation') {
        conv.title = text.trim().substring(0, 30) + (text.trim().length > 30 ? '...' : '');
      }
      
      conv.updatedAt = Date.now();
      persist(); 
      renderMessages();
      renderHistory(); // Update history to show new title/preview

      const loadingMsg = { role: 'bot', text: 'â€¦', time: timeNow(), loading: true };
      conv.messages.push(loadingMsg);
      persist(); 
      renderMessages();

      const payload = { input: text.trim(), sessionId: getSessionId() };
      
      try {
        sendBtn.disabled = true;
        inputEl.disabled = true;
        
        // --- FAKE BOT RESPONSE (for testing without webhook) ---
        await new Promise(res => setTimeout(res, 1500)); // Simulate network delay
        // --- Example of sending HTML ---
        const data = { 
            output: `<h1>Test Heading 1</h1>
<p>This is a paragraph response to your message: "${text.trim()}".</p>
<h2>Test Heading 2</h2>
<p>This shows that HTML tags are now rendering correctly.</p>` 
        };
        // --- END FAKE BOT RESPONSE ---

        /* // --- REAL FETCH (Uncomment this block to use the webhook) ---
        const res = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const data = await res.json();
        // --- END REAL FETCH ---
        */
        
        const out = (data && data.output) ? data.output : JSON.stringify(data);
        conv.messages = conv.messages.map(m => m.loading ? { role: 'bot', text: String(out), time: timeNow() } : m);
      } catch (err) {
        console.error("Error sending message:", err);
        conv.messages = conv.messages.map(m => m.loading ? { role: 'bot', text: 'Error: ' + err.message, time: timeNow() } : m);
      } finally {
        sendBtn.disabled = false;
        inputEl.disabled = false;
        inputEl.focus();
        conv.updatedAt = Date.now();
        persist();
        renderMessages();
        renderHistory();
      }
    }

    function startNewConversation() {
      const id = makeId();
      const conv = { id, title: 'New conversation', createdAt: Date.now(), updatedAt: Date.now(), messages: [] };
      conversations.unshift(conv); // Add to the beginning
      activeId = id;
      persist();
      renderAll();
    }

    // --- Event Listeners ---
    sendBtn.addEventListener('click', () => {
      const txt = inputEl.value;
      inputEl.value = '';
      sendMessage(txt);
      autoResizeTextarea(); // Reset textarea size
    });

    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        const txt = inputEl.value;
        inputEl.value = '';
        sendMessage(txt);
        autoResizeTextarea(); // Reset textarea size
      }
    });

    newConvBtn.addEventListener('click', startNewConversation);
    newConvMobileBtn.addEventListener('click', startNewConversation); // Also link mobile button
    
    // Toggle History Panel on Mobile
    const historyPanel = $('#historyPanel');
    const historyToggleBtn = $('#historyToggle');
    if (historyToggleBtn && historyPanel) {
        historyToggleBtn.addEventListener('click', () => {
            // This is a simple toggle, you might want more complex logic
            historyPanel.classList.toggle('hidden');
            historyPanel.classList.toggle('flex');
            // On mobile, you'd want it to overlay or push content
            // This simple toggle will just show/hide it.
            console.log("History panel toggled. Needs more complex layout logic for mobile overlay.");
        });
    }


    // --- Initial Load ---
    load();
    
  </script>
</body>
</html>

